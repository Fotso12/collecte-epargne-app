<div class="container-fluid mt-2">
  <div class="dashboard-header mb-4">
    <h2 class="text-dark fw-bold"><i class="fas fa-users me-2"></i>{{ titrePage }}</h2>
    <p class="text-muted">Gestion administrative SAVELY</p>
  </div>

  <div class="card shadow-sm mb-4 border-0 rounded-4">
    <div class="card-body">
      <div class="row align-items-center g-3">
        <div class="col-md-8">
          <div class="input-group bg-light rounded-pill px-3">
            <span class="input-group-text bg-transparent border-0"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control border-0 bg-transparent shadow-none" 
                   [(ngModel)]="filtreMatricule" (input)="appliquerFiltres()" placeholder="Rechercher par nom, prénom ou matricule...">
          </div>
        </div>
        <div class="col-md-4 text-md-end">
          <button class="btn btn-info text-white rounded-pill px-4 shadow-sm" (click)="ouvrirModalAjout()">
            <i class="fas fa-plus-circle me-2"></i>Nouveau {{ typeActuel === 'COLLECTEUR' ? 'Collecteur' : 'Caissier' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="table-container shadow-sm border-0">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th class="ps-4">Matricule</th>
          <th>Employé / Login</th>
          <th *ngIf="typeActuel === 'COLLECTEUR'">Commission</th>
          <th class="text-center">Statut (Contrôle)</th>
          <th class="text-end pe-4">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let e of employesFiltres">
          <td class="ps-4"><span class="badge bg-light text-dark border font-monospace">{{ e.matricule }}</span></td>
          <td>
            <div class="d-flex align-items-center gap-3">
              <span class="avatar">{{ e.nom[0] }}{{ e.prenom[0] }}</span>
              <div class="d-flex flex-column">
                <span class="fw-semibold">{{ e.nom }} {{ e.prenom }}</span>
                <small class="text-primary fw-bold">{{ e.loginUtilisateur }}</small>
              </div>
            </div>
          </td>
          <td *ngIf="typeActuel === 'COLLECTEUR'">
            <span class="badge bg-success-subtle text-success">{{ e.commissionTaux }}%</span>
          </td>
          <td class="text-center">
            <div class="btn-group p-1 bg-light border rounded-pill" style="transform: scale(0.85);">
              <button *ngFor="let st of listeStatuts" class="btn btn-sm rounded-pill px-3 transition-all"
                [ngClass]="getStatutBtnClass(e.statut, st)" (click)="ouvrirConfirmationStatut(e, st)">
                {{ st }}
              </button>
            </div>
          </td>
          <td class="text-end pe-4">
            <button *ngIf="typeActuel === 'COLLECTEUR'" class="btn btn-sm btn-light border me-1" (click)="ouvrirListeClients(e)" title="Voir ses clients">
              <i class="fas fa-users text-info"></i>
            </button>
            
            <button class="btn btn-sm btn-light border me-1" (click)="voirDetails(e)" title="Détails"><i class="fas fa-eye text-primary"></i></button>
            <button class="btn btn-sm btn-light border me-1" (click)="ouvrirModalModification(e)" title="Modifier"><i class="fas fa-edit text-warning"></i></button>
            <button class="btn btn-sm btn-light border" (click)="ouvrirConfirmationSuppression(e)" title="Supprimer"><i class="fas fa-trash text-danger"></i></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal-backdrop-custom" *ngIf="isClientsModalOpen" (click)="fermerModalClients()"></div>
<div class="modal-wrapper-custom" *ngIf="isClientsModalOpen" style="max-width: 800px;">
  <div class="modal-content-custom shadow-lg">
    <div class="modal-header-custom bg-info text-white">
      <h5 class="m-0 fw-bold"><i class="fas fa-users me-2"></i>Clients de {{ collecteurActif?.nom }} {{ collecteurActif?.prenom }}</h5>
      <button class="btn-close-custom text-white" (click)="fermerModalClients()">&times;</button>
    </div>
    <div class="modal-body-custom p-0">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="bg-light">
            <tr>
              <th class="ps-4">Code Client</th>
              <th>Nom & Prénoms</th>
              <th>Téléphone</th>
              <th class="text-end pe-4">Solde</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of clientsAffiches">
              <td class="ps-4 fw-bold small">{{ c.codeClient }}</td>
              <td>{{ c.nom }} {{ c.prenom }}</td>
              <td>{{ c.telephone }}</td>
              <td class="text-end pe-4 fw-bold text-success">{{ c.solde | number }} FCFA</td>
            </tr>
            <tr *ngIf="clientsAffiches.length === 0">
              <td colspan="4" class="text-center p-4 text-muted">Aucun client rattaché à ce collecteur.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer-custom d-flex justify-content-between align-items-center" *ngIf="tousLesClientsDuCollecteur.length > 0">
      <span class="small text-muted">Total : {{ tousLesClientsDuCollecteur.length }} clients</span>
      <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-sm btn-outline-secondary rounded-pill" [disabled]="pageActuelleClient === 1" (click)="changerPageClient(-1)">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="fw-bold px-2">{{ pageActuelleClient }} / {{ totalPagesClient }}</span>
        <button class="btn btn-sm btn-outline-secondary rounded-pill" [disabled]="pageActuelleClient === totalPagesClient" (click)="changerPageClient(1)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop-custom" *ngIf="isAddModalOpen" (click)="fermerModalAjout()"></div>
<div class="modal-wrapper-custom" *ngIf="isAddModalOpen">
  <div class="modal-content-custom shadow-lg">
    <div class="modal-header-custom" [ngClass]="isEditMode ? 'bg-warning' : 'bg-dark text-white'">
      <h5 class="m-0 fw-bold text-white">{{ isEditMode ? 'Modifier' : 'Ajouter' }} {{ typeActuel }}</h5>
      <button class="btn-close-custom text-white" (click)="fermerModalAjout()">&times;</button>
    </div>
    <form [formGroup]="employeForm" (ngSubmit)="enregistrer()">
      <div class="modal-body-custom">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label small fw-bold">Nom</label><input type="text" class="form-control" formControlName="nom"></div>
          <div class="col-md-6"><label class="form-label small fw-bold">Prénom</label><input type="text" class="form-control" formControlName="prenom"></div>
          <div class="col-md-6"><label class="form-label small fw-bold">Login</label><input type="text" class="form-control" formControlName="login"></div>
          <div class="col-md-6"><label class="form-label small fw-bold">Email</label><input type="email" class="form-control" formControlName="email"></div>
          <div class="col-md-6" *ngIf="!isEditMode"><label class="form-label small fw-bold">Mot de passe</label><input type="password" class="form-control" formControlName="password"></div>
          <div class="col-md-6"><label class="form-label small fw-bold">Téléphone</label><input type="text" class="form-control" formControlName="telephone"></div>
          <div class="col-md-6"><label class="form-label small fw-bold">Date Embauche</label><input type="date" class="form-control" formControlName="dateEmbauche"></div>
          <div class="col-md-6" *ngIf="typeActuel === 'COLLECTEUR'"><label class="form-label small fw-bold text-success">Commission (%)</label><input type="number" class="form-control border-success" formControlName="commissionTaux"></div>
        </div>
      </div>
      <div class="modal-footer-custom text-end">
        <button type="button" class="btn btn-link text-muted me-3" (click)="fermerModalAjout()">Annuler</button>
        <button type="submit" class="btn btn-primary px-5 rounded-pill shadow" [disabled]="employeForm.invalid">
          {{ isEditMode ? 'Enregistrer les modifications' : 'Créer le compte' }}
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal-backdrop-custom" *ngIf="isModalOpen" (click)="fermerModal()"></div>
<div class="modal-wrapper-custom" *ngIf="isModalOpen">
  <div class="modal-content-custom shadow-lg" *ngIf="employeSelectionne">
    <div class="modal-header-custom bg-primary text-white">
      <h5 class="m-0 fw-bold"><i class="fas fa-id-card me-2"></i>Fiche Détaillée : {{ employeSelectionne.nom }}</h5>
      <button class="btn-close-custom text-white" (click)="fermerModal()">&times;</button>
    </div>
    <div class="modal-body-custom">
      <div class="text-center mb-4">
        <div class="avatar mx-auto mb-2" style="width: 80px; height: 80px; font-size: 2rem;">
          {{ employeSelectionne.nom[0] }}{{ employeSelectionne.prenom[0] }}
        </div>
        <h4 class="mb-0 fw-bold">{{ employeSelectionne.nom }} {{ employeSelectionne.prenom }}</h4>
        <span class="badge bg-light text-primary border">{{ employeSelectionne.matricule }}</span>
      </div>
      <hr>
      <div class="row gy-4">
        <div class="col-md-6"><label class="text-muted small d-block mb-1">Nom d'utilisateur</label><span class="fw-bold">{{ employeSelectionne.loginUtilisateur }}</span></div>
        <div class="col-md-6"><label class="text-muted small d-block mb-1">Adresse Email</label><span class="fw-bold">{{ employeSelectionne.email }}</span></div>
        <div class="col-md-6"><label class="text-muted small d-block mb-1">Téléphone</label><span class="fw-bold">{{ employeSelectionne.telephone }}</span></div>
        <div class="col-md-6"><label class="text-muted small d-block mb-1">Date d'embauche</label><span class="fw-bold">{{ employeSelectionne.dateEmbauche | date:'longDate':'':'fr' }}</span></div>
        <div class="col-md-6"><label class="text-muted small d-block mb-1">Statut actuel</label><span class="badge" [ngClass]="{'bg-success': employeSelectionne.statut === 'ACTIF', 'bg-danger': employeSelectionne.statut === 'INACTIF', 'bg-warning text-dark': employeSelectionne.statut === 'SUSPENDU'}">{{ employeSelectionne.statut }}</span></div>
        <div class="col-md-6" *ngIf="typeActuel === 'COLLECTEUR'"><label class="text-muted small d-block mb-1">Taux Commission</label><span class="fw-bold text-success">{{ employeSelectionne.commissionTaux }}%</span></div>
      </div>
    </div>
    <div class="modal-footer-custom"><button class="btn btn-secondary w-100 rounded-pill" (click)="fermerModal()">Fermer la fiche</button></div>
  </div>
</div>

<div class="modal-backdrop-custom" *ngIf="confirmSuppression.show" style="z-index: 5500;"></div>
<div class="modal-wrapper-custom" *ngIf="confirmSuppression.show" style="z-index: 5501; max-width: 400px;">
  <div class="modal-content-custom p-4 text-center">
    <div class="text-danger mb-3"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
    <h5 class="fw-bold">Supprimer définitivement ?</h5>
    <p class="text-muted">Voulez-vous supprimer l'employé <strong>{{ confirmSuppression.nom }}</strong> ?</p>
    <div class="d-flex gap-2 mt-4">
      <button class="btn btn-light w-100 rounded-pill border" (click)="confirmSuppression.show = false">Annuler</button>
      <button class="btn btn-danger w-100 rounded-pill shadow" (click)="confirmerSuppression()">Supprimer</button>
    </div>
  </div>
</div>

<div class="modal-backdrop-custom" *ngIf="confirmStatut.show" style="z-index: 5200;"></div>
<div class="modal-wrapper-custom" *ngIf="confirmStatut.show" style="z-index: 5201; max-width: 380px;">
  <div class="modal-content-custom p-4 text-center border-0 shadow-lg">
    <div class="text-primary mb-3"><i class="fas fa-user-shield fa-3x"></i></div>
    <h6 class="fw-bold">Modifier les accès ?</h6>
    <p class="small text-muted">Passer le statut à <span class="badge bg-info">{{ confirmStatut.nouveauStatut }}</span> ?</p>
    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-light w-100 rounded-pill border" (click)="confirmStatut.show = false">Annuler</button>
      <button class="btn btn-primary w-100 rounded-pill shadow" (click)="confirmerChangementStatut()">Confirmer</button>
    </div>
  </div>
</div>

<div class="feedback shadow-lg p-3 rounded-pill" *ngIf="feedbackModal.show" [ngClass]="feedbackModal.isError ? 'bg-danger' : 'bg-success'">
  <i class="fas me-2" [ngClass]="feedbackModal.isError ? 'fa-times-circle' : 'fa-check-circle'"></i>
  {{ feedbackModal.message }}
</div>