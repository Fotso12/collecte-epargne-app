<div class="container-fluid mt-2">
  <div class="dashboard-header mb-4">
    <h2 class="text-dark fw-bold"><i class="fas fa-users me-2"></i>{{ titrePage }}</h2>
    <p class="text-muted">Gérez les accès et les informations des {{ typeActuel | lowercase }}s du réseau SAVELY</p>
  </div>

  <div class="card shadow-sm mb-4 border-0" style="border-radius: 12px; background: white;">
    <div class="card-body">
      <div class="row align-items-center g-3">
        <div class="col-md-8">
          <div class="input-group bg-light rounded-pill px-3">
            <span class="input-group-text bg-transparent border-0"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control border-0 bg-transparent shadow-none" 
                   placeholder="Rechercher par matricule ou nom..." 
                   [(ngModel)]="filtreMatricule" (input)="appliquerFiltres()">
          </div>
        </div>
        <div class="col-md-4 text-md-end">
          <button class="btn btn-primary rounded-pill px-4 shadow-sm" (click)="ouvrirModalAjout()">
            <i class="fas fa-plus-circle me-2"></i>Nouveau {{ typeActuel | lowercase }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="table-container shadow-sm border-0">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th class="ps-4">Matricule</th>
          <th>Employé / Login</th>
          <th *ngIf="typeActuel === 'COLLECTEUR'">Commission</th>
          <th class="text-center">Statut (Actions)</th>
          <th class="text-end pe-4">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let e of employesFiltres">
          <td class="ps-4">
            <span class="badge bg-light text-dark border">{{ e.matricule }}</span>
          </td>
          <td>
            <div class="user-cell d-flex align-items-center gap-3">
              <span class="avatar">{{ (e.nom.substring(0,1) || '') + (e.prenom.substring(0,1) || '') }}</span>
              <div class="d-flex flex-column">
                <span class="fw-semibold">{{ e.nom }} {{ e.prenom }}</span>
                <small class="text-primary" style="font-size: 0.75rem;">{{ e.loginUtilisateur }}</small>
              </div>
            </div>
          </td>
          <td *ngIf="typeActuel === 'COLLECTEUR'">
            <span class="fw-bold text-success">{{ e.commissionTaux }}%</span>
          </td>
          <td class="text-center">
            <div class="btn-group p-1 bg-light border rounded-pill" style="transform: scale(0.9);">
              <button *ngFor="let st of listeStatuts" 
                class="btn btn-sm rounded-pill px-3 fw-bold border-0 transition-all"
                [ngClass]="getStatutBtnClass(e.statut, st)"
                (click)="ouvrirConfirmationStatut(e, st)">
                {{ st }}
              </button>
            </div>
          </td>
          <td class="text-end pe-4">
            <button class="btn btn-sm btn-light border me-1" (click)="voirDetails(e)">
              <i class="fas fa-eye text-primary"></i>
            </button>
            <button class="btn btn-sm btn-light border">
              <i class="fas fa-trash text-danger"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal-backdrop-custom" *ngIf="isModalOpen" (click)="fermerModal()"></div>
<div class="modal-wrapper-custom" *ngIf="isModalOpen">
  <div class="modal-content-custom shadow-lg" *ngIf="employeSelectionne">
    <div class="modal-header-custom">
      <h5 class="m-0 fw-bold"><i class="fas fa-id-card me-2 text-primary"></i>Fiche {{ typeActuel | lowercase }}</h5>
      <button class="btn-close-custom" (click)="fermerModal()">&times;</button>
    </div>
    <div class="modal-body-custom">
      <div class="row g-4">
        <div class="col-md-6 border-end">
          <h6 class="text-primary fw-bold mb-3 border-bottom pb-1">Identité</h6>
          <p class="mb-2"><strong>Nom Complet:</strong> {{ employeSelectionne.nom }} {{ employeSelectionne.prenom }}</p>
          <p class="mb-2"><strong>Matricule:</strong> <span class="badge bg-dark">{{ employeSelectionne.matricule }}</span></p>
          <p class="mb-2"><strong>Téléphone:</strong> {{ employeSelectionne.telephone }}</p>
          <p class="mb-2"><strong>Email:</strong> {{ employeSelectionne.email }}</p>
        </div>
        <div class="col-md-6">
          <h6 class="text-primary fw-bold mb-3 border-bottom pb-1">Contrat & Accès</h6>
          <p class="mb-2"><strong>Login:</strong> <span class="text-primary fw-bold">{{ employeSelectionne.loginUtilisateur }}</span></p>
          <p class="mb-2"><strong>Embauche:</strong> {{ employeSelectionne.dateEmbauche | date:'dd MMMM yyyy' }}</p>
          <p class="mb-2" *ngIf="typeActuel === 'COLLECTEUR'"><strong>Taux Commission:</strong> {{ employeSelectionne.commissionTaux }}%</p>
          <p class="mb-2"><strong>Statut Actuel:</strong> 
            <span class="badge bg-success-subtle text-success">{{ employeSelectionne.statut }}</span>
          </p>
        </div>
      </div>
    </div>
    <div class="modal-footer-custom text-end">
      <button class="btn btn-secondary px-4 rounded-pill" (click)="fermerModal()">Fermer</button>
    </div>
  </div>
</div>

<div class="modal-backdrop-custom" *ngIf="isAddModalOpen" (click)="fermerModalAjout()"></div>
<div class="modal-wrapper-custom" *ngIf="isAddModalOpen">
  <div class="modal-content-custom shadow-lg">
    <div class="modal-header-custom bg-dark text-white">
      <h5 class="m-0 fw-bold text-white">Nouveau {{ typeActuel }}</h5>
      <button class="btn-close-custom text-white" (click)="fermerModalAjout()">&times;</button>
    </div>
    <form [formGroup]="employeForm" (ngSubmit)="enregistrer()">
      <div class="modal-body-custom">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label small fw-bold">Nom</label>
            <input type="text" class="form-control bg-light" formControlName="nom">
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold">Prénom</label>
            <input type="text" class="form-control bg-light" formControlName="prenom">
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold">Login</label>
            <input type="text" class="form-control bg-light" formControlName="login">
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold">Mot de passe</label>
            <input type="password" class="form-control bg-light" formControlName="password">
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold">Email</label>
            <input type="email" class="form-control bg-light" formControlName="email">
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold">Téléphone</label>
            <input type="text" class="form-control bg-light" formControlName="telephone">
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold">Date Embauche</label>
            <input type="date" class="form-control bg-light" formControlName="dateEmbauche">
          </div>
          <div class="col-md-6" *ngIf="typeActuel === 'COLLECTEUR'">
            <label class="form-label small fw-bold text-success">Commission (%)</label>
            <input type="number" class="form-control border-success bg-success-subtle" formControlName="commissionTaux">
          </div>
        </div>
      </div>
      <div class="modal-footer-custom text-end">
        <button type="button" class="btn btn-link text-muted me-3" (click)="fermerModalAjout()">Annuler</button>
        <button type="submit" class="btn btn-primary px-5 rounded-pill shadow" [disabled]="employeForm.invalid">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<div class="modal-backdrop-custom" *ngIf="confirmStatut.show" style="z-index: 5000;"></div>
<div class="modal-wrapper-custom" *ngIf="confirmStatut.show" style="z-index: 5001; max-width: 350px;">
  <div class="modal-content-custom p-4 text-center">
    <div class="mb-3"><i class="fas fa-exclamation-triangle fa-3x text-warning"></i></div>
    <h6 class="fw-bold">Confirmation</h6>
    <p class="small text-muted">Voulez-vous vraiment changer le statut de cet employé en <strong>{{ confirmStatut.nouveauStatut }}</strong> ?</p>
    <div class="d-flex gap-2">
      <button class="btn btn-light border w-100 rounded-pill" (click)="confirmStatut.show = false">Annuler</button>
      <button class="btn btn-primary w-100 rounded-pill" (click)="confirmerChangementStatut()">Confirmer</button>
    </div>
  </div>
</div>

<div class="feedback shadow-lg p-3 rounded-pill" *ngIf="feedbackModal.show" 
     [ngClass]="feedbackModal.isError ? 'bg-danger' : 'bg-success'">
  <i class="fas me-2" [ngClass]="feedbackModal.isError ? 'fa-times-circle' : 'fa-check-circle'"></i>
  {{ feedbackModal.message }}
</div>